[//]: # template for any of the static web pages generated to display 
[//]: # visulization output from our HMP2 analysis pipelines

<<label="document_setup", echo=False>>=
from anadama2 import PweaveDocument

from biobakery_workflows import utilities

document = PweaveDocument()
#vars = document.get_vars()

vars = {} 

vars['total_species'] = 1234
vars['min_abundance'] = 0.8
vars['total_species_post_filtering'] = 777
vars['species_counts_table'] = "foo.csv"

sample_name = "MSM5HLLR"
vars['summary_page_title'] = "HMP2 Metagenomics Dataset Summary"
max_sets_heatmap = 25
@


<!doctype html>
<html lang="en">

<head>
<title><%= vars['summary_page_title'] %></title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
<script src="https://code.jquery.com/jquery-1.7.1.min.js" integrity="sha256-iBcUE/x23aI6syuqF7EeT/+JFBxjPs5zeFJEXxumwb0=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
</head>

<body id="body">
<div class="container">
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container-fluid">
<div class="navbar-header">
<a class="navbar-brand" href="/" style="padding: 0px 10px;">
<img src="/static/img/gut_cartoon.png" alt="IBDMDB.org" height="50" width="50">
</a>
</div>

<ul class="nav navbar-nav">
<li id="dropdown-menu-home"><a href="/">Home</a></li>
<li class="active" id="-results"><a href="/results">Download Data</a></li>
<li class="" id="-cb-browser"><a href="/cb/browser">Protocols</a></li>
<li class="" id="project"><a href="/project/">Team</a></li>
<li class="" id="-participant"><a href="/participant">Participant Interface</a></li>
</ul>
</div>
</div>

<div class="Row">
<div class="page-header">

### <%= vars['summary_page_title'] %>

<span>The following data were run through a standard workflow for metagenomic sequence analysis.</span>
</div>
</div>

<!-- Main page content follows -->
<div id="main_content" class="Row">
<ul class="nav nav-tabs">
<li role="presentation" class="active"><a href="#qc" data-toggle="tab">Quality Control</a></li>
<li role="presentation"><a href="#taxonomy" data-toggle="tab">Taxonomy</a></li>
<li role="presentation"><a href="#func_profiling" data-toggle="tab">Functional Profiling</a></li>
</ul>

<div class="panel-body">
<div clas="tab-content">

<div class="tab-pane" id="taxonomy">

## Taxonomic Profiling

Taxonomic profiling for sample <%= sample_name %> was generated 
using [MetaPhlAn2](http://huttenhower.sph.harvard.edu/metaphlan2).

Species abundances are passed through a basic filter requiring each species
to have at least <%= vars['min_abundance'] %> % abundance.

A total of <%= vars['total_species'] %> were identified. After basic filtering
<%= vars['total_species_post_filtering'] %> species remained.

### Species Count Table

<div id="species_count_div">
<table id="species_count_table" class="table table-striped"
cellspacing="0" width="100%">
<thead>
<tr>
<th>Sample Name</th>
<th>Total</th>
<th>After Filter</th>
</tr>
</thead>
</table>
</div>

Download Species Counts Table: [species_counts_table.tsv](<%= vars['species_counts_table'] %>)

### Ordination

Principal coordinate analysis of variance among samples, based on Bray-Curtis dissimilarities between 
species profiles of samples. Filtered species' relative abundances were arcsin-square root transformed
to approximate a normal distribution and down-weight the effect of highly abundant species on
Bray-Curtis dissimilarities. Numbers in paranthesis on each axis represent the amount of variance 
explained by that axis.

<<label="ordination_setup", echo=False>>=
#top_taxonomy, top_data = utilities.top_rows(species_taxonomy, species_data, max_sets_heatmap,
#    function="average") 

#pcoa_data = numpy.array(top_data)/100.0
#caption = document.show_pcoa(samples,top_taxonomy,pcoa_data,"Ordination of species abundances")
@


### Heatmap

The top <%= max_sets_heatmap %> species based on average relative abundances are show in the heatmap.
The heatmap was generated with [Hclust2](https://bitbucket.org/nsegata/hclust2).

<<label="heatmap", echo=False>>=
#utilities.change_pweave_figure_size_heatmap(pdf_format)

#document.show_hclust2(samples,top_taxonomy,top_data,
#                      title="Top "+str(max_sets_heatmap)+" species by average abundance")

@

Hierarchical clustering of samples and species, using top <%= max_sets_heatmap %> species with highest
mean relative abundance among samples.  Abundances were log10 transformed prior to clustering, and the
"average linkage" clustering on the Euclidean distance metric was used to cluster samples.  The species
dendrogram is based on pairwise (Spearman) correlation between species.  Samples are columns and species
are rows. The color bar represents relative abundances on a log10 scale.

<<echo=False>>=
utilities.reset_pweave_figure_size()
@

### Barplot

<div id="taxonomy_barplot"></div>

Stacked barplot of 15 most abundant species among samples. Samples in the plot were sorted on the 
species with the highest mean abundances among samples in decreasing order.

</div>

</div>
</div>
</div>
</div>
</html>